<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataGym Analyze | Running</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="https://farreset.github.io/DataGym/css/style.css">
    <!-- Icons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <!-- MediaPipe Pose -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
        crossorigin="anonymous"></script>

    <!-- React & Tailwind for Trail Calculator -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Scoped styles for React component */
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }

        /* Custom Inputs for Nutrition V4 */
        .input-dark {
            background-color: #1e293b;
            border: 1px solid #334155;
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            width: 100%;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .input-dark:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* Grid Layout helpers */
        .panel {
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: #94a3b8;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Prevent Tailwind preflight from wrecking Bootstrap */
        /* We rely on specific classes or Bootstrap overrides */
    </style>
</head>

<body>

    <!-- Background Animation -->
    <div class="bg-gradient-animation"></div>

    <!-- Sidebar injected by common.js -->

    <!-- Main Content -->
    <main class="main-content">
        <div id="module-running" class="module-content">
            <header class="page-header">
                <h1 class="page-title" data-i18n="run_title">Running Analysis</h1>
                <p class="text-secondary" data-i18n="run_subtitle">Track mechanics and pace</p>
                <div class="mt-3">
                </div>
            </header>

            <!-- Tabs -->
            <ul class="nav nav-tabs" id="runTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="run-calc-tab" data-bs-toggle="tab"
                        data-bs-target="#run-calc-pane" type="button" role="tab">
                        <ion-icon name="speedometer-outline" class="me-2"></ion-icon><span data-i18n="tab_zones">Zone
                            Calculator</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="run-pro-tab" data-bs-toggle="tab" data-bs-target="#run-pro-pane"
                        type="button" role="tab">
                        <ion-icon name="pulse-outline" class="me-2"></ion-icon>RunnerPro Suite
                    </button>
                </li>
                <!--<li class="nav-item" role="presentation">
                    <button class="nav-link" id="run-pace-tab" data-bs-toggle="tab" data-bs-target="#run-pace-pane"
                        type="button" role="tab">
                        <ion-icon name="stopwatch-outline" class="me-2"></ion-icon>Pace & PPM
                    </button>
                </li>-->
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="run-trail-tab" data-bs-toggle="tab" data-bs-target="#run-trail-pane"
                        type="button" role="tab">
                        <ion-icon name="earth-outline" class="me-2"></ion-icon>Trail / Mountain
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="run-nutri-tab" data-bs-toggle="tab" data-bs-target="#run-nutri-pane"
                        type="button" role="tab">
                        <ion-icon name="nutrition-outline"></ion-icon>
                        <span>Calculadora Nutrail</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="run-ai-tab" data-bs-toggle="tab" data-bs-target="#run-ai-pane"
                        type="button" role="tab">
                        <ion-icon name="videocam-outline" class="me-2"></ion-icon><span data-i18n="tab_ai">AI
                            Analyzer</span>
                    </button>
                </li>

            </ul>

            <div class="tab-content" id="runTabsContent">
                <!-- RunnerPro Suite Tab -->
                <div class="tab-pane fade" id="run-pro-pane" role="tabpanel">

                    <!-- Inner Navigation for Suite -->
                    <div class="d-flex justify-content-center mb-4">
                        <ul class="nav nav-pills gap-3 p-2 bg-dark bg-opacity-40 rounded-4 border border-dark border-opacity-5 glass-card"
                            id="proSuiteTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button
                                    class="nav-link active btn-sm rounded-3 d-flex align-items-center gap-2 px-3 py-2 transition-all hover-glow"
                                    id="pro-vam-tab" data-bs-toggle="pill" data-bs-target="#pro-vam-pane" type="button"
                                    role="tab">
                                    <ion-icon name="speedometer-outline"></ion-icon>
                                    <span>Calculadora VAM</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button
                                    class="nav-link btn-sm rounded-3 d-flex align-items-center gap-2 px-3 py-2 transition-all hover-glow"
                                    id="pro-pred-tab" data-bs-toggle="pill" data-bs-target="#pro-pred-pane"
                                    type="button" role="tab">
                                    <ion-icon name="trending-up-outline"></ion-icon>
                                    <span>Predicción Carrera</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button
                                    class="nav-link btn-sm rounded-3 d-flex align-items-center gap-2 px-3 py-2 transition-all hover-glow"
                                    id="pro-bio-tab" data-bs-toggle="pill" data-bs-target="#pro-bio-pane" type="button"
                                    role="tab">
                                    <ion-icon name="shield-checkmark-outline"></ion-icon>
                                    <span>Biomecánica</span>
                                </button>
                            </li>

                        </ul>
                    </div>

                    <div class="tab-content" id="proSuiteContent">

                        <!-- 1. VAM & ZONES -->
                        <div class="tab-pane fade show active" id="pro-vam-pane" role="tabpanel">
                            <div class="row g-4">
                                <div class="col-lg-4">
                                    <!-- Test Settings -->
                                    <div class="glass-card mb-4 border-start border-4 border-primary">
                                        <h5 class="text-white mb-3 text-primary"><ion-icon name="timer-outline"
                                                class="me-2"></ion-icon>Configuración del Test</h5>
                                        <div class="mb-3">
                                            <label class="form-label text-white-50 small">Tipo de Test</label>
                                            <div class="d-flex bg-dark bg-opacity-50 rounded p-1 mb-3">
                                                <input type="radio" class="btn-check" name="testType" id="test6m"
                                                    value="6" checked autocomplete="off">
                                                <label class="btn btn-outline-primary btn-sm flex-grow-1" for="test6m">6
                                                    min</label>
                                                <input type="radio" class="btn-check" name="testType" id="test12m"
                                                    value="12" autocomplete="off">
                                                <label class="btn btn-outline-primary btn-sm flex-grow-1"
                                                    for="test12m">12 min (Cooper)</label>
                                            </div>

                                            <label class="form-label text-white-50 small">Distancia Reales
                                                (metros)</label>
                                            <input type="number" id="proVamDist"
                                                class="form-control bg-dark text-white border-secondary" value="1300">
                                            <div class="form-text text-secondary small">Distancia total recorrida en el
                                                test.</div>
                                        </div>
                                    </div>

                                    <!-- Heart Rate Section -->
                                    <div class="glass-card mb-4 border-start border-4 border-danger">
                                        <h5 class="text-white mb-3 text-danger"><ion-icon name="heart-outline"
                                                class="me-2"></ion-icon>Datos Cardíacos</h5>
                                        <div class="row g-2 mb-3">
                                            <div class="col-6">
                                                <label class="form-label text-white-50 small">FC Máxima</label>
                                                <input type="number" id="fcMax"
                                                    class="form-control bg-dark text-white border-secondary"
                                                    value="185">
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label text-white-50 small">FC Reposo</label>
                                                <input type="number" id="fcRest"
                                                    class="form-control bg-dark text-white border-secondary" value="60">
                                            </div>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="useKarvonen" checked>
                                            <label class="form-check-label text-white-50 small"
                                                for="useKarvonen">Fórmula Karvonen (Preferencia)</label>
                                        </div>
                                    </div>

                                    <div class="row g-2">
                                        <div class="col-6">
                                            <div
                                                class="p-3 rounded-4 bg-primary bg-opacity-50 border border-primary border-opacity-25 text-center shadow-lg transition-transform hover-scale">
                                                <div class="text-white fw-bold text-uppercase mb-1"
                                                    style="font-size: 0.65rem; letter-spacing: 0.05rem;">VAM Personal
                                                </div>
                                                <div class="h2 fw-bold text-white mb-0 font-monospace" id="resProVam">--
                                                </div>
                                                <div class="text-white-50 opacity-75 small" style="font-size: 0.65rem;">
                                                    km/h</div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div
                                                class="p-3 rounded-4 bg-indigo bg-opacity-20 border border-indigo border-opacity-25 text-center shadow-lg transition-transform hover-scale">
                                                <div class="text-indigo-emphasis fw-bold text-uppercase mb-1"
                                                    style="font-size: 0.65rem; letter-spacing: 0.05rem;">VO2max Est.
                                                </div>
                                                <div class="h2 fw-bold text-white mb-0 font-monospace" id="resProVo2">--
                                                </div>
                                                <div class="text-white-50 opacity-75 small" style="font-size: 0.65rem;">
                                                    ml/kg/min</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-lg-8">
                                    <div class="glass-card h-100 border-0 shadow-2xl overflow-hidden"
                                        style="background: rgba(15, 23, 42, 0.4);">
                                        <div class="d-flex justify-content-between align-items-center mb-4 px-2">
                                            <h5 class="text-white mb-0 fw-bold"><ion-icon name="list-outline"
                                                    class="me-2 text-primary"></ion-icon>Zonas de Entrenamiento</h5>
                                            <div class="d-flex align-items-center gap-2">
                                                <div
                                                    class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 px-2 py-1">
                                                    Optimización VAM</div>
                                                <button
                                                    class="btn btn-outline-light btn-sm p-1 d-flex align-items-center"
                                                    id="btnOpenProZoneConfig" title="Configurar Rangos %VAM">
                                                    <ion-icon name="settings-outline"></ion-icon>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-dark table-hover mb-0 align-middle">
                                                <thead class="text-white-50">
                                                    <tr class="small text-uppercase"
                                                        style="letter-spacing: 0.05rem; font-size: 0.75rem;">
                                                        <th class="ps-4 border-0">Zona</th>
                                                        <th class="border-0">% VAM</th>
                                                        <th class="border-0">Ritmo (min/km)</th>
                                                        <th class="border-0">FC (bpm)</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="proZonesTableBody" class="border-0">
                                                    <!-- Injected by JS -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. RACE PREDICTOR -->
                        <div class="tab-pane fade" id="pro-pred-pane" role="tabpanel">
                            <div class="row g-4">
                                <div class="col-lg-5">
                                    <div class="glass-card border-start border-4 border-warning h-100">
                                        <h5 class="text-white mb-3 text-warning"><ion-icon name="trending-up-outline"
                                                class="me-2"></ion-icon>Marca Reciente</h5>
                                        <div class="mb-3">
                                            <label class="form-label text-white-50 small">Distancia Conocida</label>
                                            <select id="predDist"
                                                class="form-select bg-dark text-white border-secondary">
                                                <option value="5">5 km</option>
                                                <option value="10" selected>10 km</option>
                                                <option value="21.097">Media Maratón</option>
                                                <option value="42.195">Maratón</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label text-white-50 small">Tiempo (hh:mm:ss)</label>
                                            <input type="text" id="predTime"
                                                class="form-control bg-dark text-white border-secondary font-monospace"
                                                value="00:55:00">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-7">
                                    <div class="glass-card h-100 border-indigo-500 border-opacity-10">
                                        <div class="d-flex align-items-center justify-content-between mb-4">
                                            <h5 class="text-white mb-0 fw-bold"><ion-icon name="analytics-outline"
                                                    class="me-2 text-warning"></ion-icon>Potencial de Marca</h5>
                                            <small
                                                class="text-white-50 font-monospace px-2 py-1 bg-dark bg-opacity-50 rounded"
                                                style="font-size: 0.65rem;">Algorithm: Riegel v1.1</small>
                                        </div>
                                        <div class="row g-3" id="predResultsContainer">
                                            <!-- Injected by JS -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. BIOMECHANICS -->
                        <div class="tab-pane fade" id="pro-bio-pane" role="tabpanel">
                            <div class="row g-4">
                                <div class="col-lg-8">
                                    <h6 class="text-white-50 small text-uppercase mb-3">Cribado Funcional (Tests
                                        Laterales)</h6>
                                    <div id="bioChecklistContainer" class="row g-3">
                                        <!-- Injected by JS -->
                                    </div>
                                </div>

                                <div class="col-lg-4">
                                    <div class="glass-card text-center sticky-top shadow-2xl border-indigo-500 border-opacity-10"
                                        style="top: 20px;">
                                        <div class="mb-4">
                                            <ion-icon name="shield-checkmark-outline"
                                                class="text-indigo fs-1 opacity-75 mb-2"></ion-icon>
                                            <h5 class="mb-1 text-white fw-bold">Diagnosis de Riesgo</h5>
                                            <p class="text-white-50 small">Prevención de lesiones</p>
                                        </div>

                                        <div id="bioRiskBadge"
                                            class="d-inline-block px-4 py-2 rounded-pill fw-bold mb-4 border border-secondary text-secondary bg-dark bg-opacity-25 transition-all">
                                            Sin Datos
                                        </div>

                                        <div class="mb-4">
                                            <div class="d-flex justify-content-between small text-white-50 mb-1 px-1">
                                                <span>Progreso de Test</span>
                                                <span id="bioProgressPct">0%</span>
                                            </div>
                                            <div class="progress bg-dark bg-opacity-50"
                                                style="height: 8px; border-radius: 4px;">
                                                <div id="bioProgressBar"
                                                    class="progress-bar bg-primary transition-all shadow-glow"
                                                    role="progressbar" style="width: 0%"></div>
                                            </div>
                                        </div>

                                        <div
                                            class="p-3 rounded-3 bg-white bg-opacity-5 text-start border border-white border-opacity-10">
                                            <p class="small text-secondary mb-0 line-height-sm">
                                                Completa los 6 tests biomecánicos para identificar desequilibrios
                                                musculares. El diagnóstico ayuda a prevenir lesiones comunes como la
                                                <strong>fascitis plantar</strong> o el <strong>síndrome de la
                                                    cintilla iliotibial</strong>.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>



                    </div>

                </div>
                <!-- Zone Calculator Tab -->
                <div class="tab-pane fade show active" id="run-calc-pane" role="tabpanel">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="glass-card h-100">
                                <h5 class="mb-4" data-i18n="run_calc_title">VAM Calculator</h5>
                                <div class="mb-4">
                                    <label class="form-label" data-i18n="vam_label">VAM (MM:SS / km)</label>
                                    <input type="text" class="form-control form-control-lg text-center" id="inputVam"
                                        placeholder="04:00">
                                    <div class="form-text text-secondary" data-i18n="vam_help">Enter your Maximum
                                        Aerobic Speed pace.</div>
                                </div>
                                <button class="btn btn-primary w-100" id="btnCalcZones"
                                    data-i18n="btn_calc_zones">Calculate Zones</button>
                                <button class="btn btn-outline-light btn-sm w-100 mt-3" id="btnOpenZoneConfig">
                                    <ion-icon name="options-outline" class="me-2"></ion-icon>
                                    <span data-i18n="nav_zone_config">Zone Config.</span>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <div class="glass-card h-100">
                                <h5 class="mb-3" data-i18n="zones_result_title">Training Zones</h5>
                                <div id="zonesResult" class="d-flex flex-column gap-2">
                                    <p class="text-secondary fst-italic text-center mt-5" data-i18n="zones_waiting">
                                        Enter VAM to see zones.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Nutrition PRO Tab (Main Level) -->
                <div class="tab-pane fade" id="run-nutri-pane" role="tabpanel">
                    <div id="trail-nutrition-root"></div>
                </div>
                <!-- Trail Running / Mountain Analytics Tab -->
                <div class="tab-pane fade" id="run-trail-pane" role="tabpanel">
                    <div class="row">
                        <!-- INTRODUCCIÓN -->
                        <div class="col-12 mb-4">
                            <div class="glass-card border-start border-4 border-success">
                                <h4 class="text-white mb-2"><ion-icon name="trail-sign-outline"
                                        class="me-2"></ion-icon>Trail Running Analytics</h4>
                                <p class="text-secondary mb-0">
                                    En la montaña, el ritmo por kilómetro (min/km) no cuenta toda la verdad. Esta
                                    herramienta utiliza algoritmos científicos (Minetti, Banister) para calcular tu
                                    <strong class="text-success">Esfuerzo Real (GAP)</strong>, <strong
                                        class="text-danger">Carga Interna (TRIMP)</strong> y <strong
                                        class="text-warning">Gasto Energético</strong> considerando la gravedad y el
                                    desnivel.
                                </p>
                            </div>
                        </div>

                        <!-- 1. GAP CALCULATOR -->
                        <div class="col-lg-6 mb-4">
                            <div class="glass-card h-100">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="bg-success bg-opacity-10 p-2 rounded me-3 text-success">
                                        <ion-icon name="speedometer" class="fs-4"></ion-icon>
                                    </div>
                                    <div>
                                        <h5 class="mb-0">Calculadora GAP (Minetti)</h5>
                                        <small class="text-secondary">Ritmo Ajustado a Pendiente</small>
                                    </div>
                                </div>

                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <label class="form-label small">Distancia (km)</label>
                                        <input type="number" id="gapDist" class="form-control" placeholder="21.5">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Desnivel Positivo (m+)</label>
                                        <input type="number" id="gapElev" class="form-control" placeholder="1200">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small">Tiempo Total (HH:MM:SS)</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-dark-subtle border-secondary"><ion-icon
                                                name="time-outline"></ion-icon></span>
                                        <input type="text" id="gapTimeInput" class="form-control"
                                            placeholder="ej. 01:45:30 o 45:00">
                                    </div>
                                </div>
                                <button class="btn btn-success w-100 mb-4" onclick="calculateGAP()">Calcular
                                    Rendimiento</button>

                                <!-- Result GAP -->
                                <div id="gapResults" class="d-none animate-slide-in">
                                    <div class="row text-center mb-3">
                                        <div class="col-6">
                                            <small class="text-secondary d-block">Ritmo Real</small>
                                            <span class="fs-4 fw-bold text-white" id="resPace">--:--</span> <small
                                                class="text-secondary">/km</small>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-success d-block fw-bold">Ritmo GAP</small>
                                            <span class="fs-3 fw-bold text-success" id="resGAP">--:--</span> <small
                                                class="text-secondary">/km</small>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <div class="progress flex-grow-1 bg-secondary bg-opacity-25"
                                            style="height: 6px;">
                                            <div id="gradeBar" class="progress-bar bg-info" role="progressbar"
                                                style="width: 0%"></div>
                                        </div>
                                        <span id="resGrade" class="text-white fw-bold small">0%</span>
                                    </div>
                                    <small class="text-secondary d-block text-end mb-3">Pendiente Media</small>

                                    <div class="alert alert-dark border-secondary mb-0 small text-start">
                                        <i class="fa-solid fa-lightbulb text-warning me-1"></i> <span
                                            id="gapExplanation">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. TRIMP CALCULATOR -->
                        <div class="col-lg-6 mb-4">
                            <div class="glass-card h-100">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="bg-danger bg-opacity-10 p-2 rounded me-3 text-danger">
                                        <ion-icon name="heart" class="fs-4"></ion-icon>
                                    </div>
                                    <div>
                                        <h5 class="mb-0">TRIMP (Carga Interna)</h5>
                                        <small class="text-secondary">Impulso de Entrenamiento (Banister)</small>
                                    </div>
                                </div>

                                <div class="row g-2 mb-3">
                                    <div class="col-8">
                                        <label class="form-label small">Duración (min)</label>
                                        <input type="number" id="trimpTime" class="form-control" placeholder="Minutos">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label small">Género</label>
                                        <select id="trimpGender"
                                            class="form-select text-white bg-dark border-secondary">
                                            <option value="male">Hombre</option>
                                            <option value="female">Mujer</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row g-2 mb-3">
                                    <div class="col-4">
                                        <label class="form-label small">FC Reposo</label>
                                        <input type="number" id="hrRest" class="form-control" placeholder="50">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label small">FC Máx</label>
                                        <input type="number" id="hrMax" class="form-control" placeholder="190">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label small">FC Media</label>
                                        <input type="number" id="hrAvg"
                                            class="form-control border-danger text-danger fw-bold" placeholder="155">
                                    </div>
                                </div>

                                <button class="btn btn-danger w-100 mb-4" onclick="calculateTRIMP()">Calcular
                                    Estrés</button>

                                <!-- Result TRIMP -->
                                <div id="trimpResults" class="d-none text-center animate-slide-in">
                                    <small class="text-secondary d-block text-uppercase"
                                        style="font-size: 0.7rem;">Puntuación TRIMP</small>
                                    <h2 class="display-3 fw-bold text-danger mb-0" id="trimpValue">--</h2>
                                    <small class="text-secondary">puntos de estrés</small>

                                    <div
                                        class="mt-3 text-start bg-dark bg-opacity-50 p-3 rounded border border-secondary border-opacity-25">
                                        <strong class="d-block text-white mb-1">Diagnóstico:</strong>
                                        <p id="trimpDiagnosis" class="small text-secondary mb-0"
                                            style="line-height: 1.4;">--</p>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- AI Analyzer Tab -->
                <div class="tab-pane fade" id="run-ai-pane" role="tabpanel">

                    <!-- 1. Input Section (Centered) -->
                    <div id="runInputSection" class="row justify-content-center">
                        <div class="col-lg-8">
                            <div class="glass-card text-center p-4">
                                <h2 class="mb-3 text-white fw-bold" data-i18n="video_upload_title">Video Upload
                                </h2>

                                <div class="d-inline-flex align-items-center justify-content-center text-start bg-info bg-opacity-10 border border-info border-opacity-25 rounded-3 p-3 mb-4 mx-auto"
                                    style="max-width: 600px;">
                                    <ion-icon name="information-circle-outline"
                                        class="text-info fs-2 me-3 flex-shrink-0"></ion-icon>
                                    <p class="text-info mb-0 small" data-i18n="video_upload_text">Upload your
                                        running video
                                        to receive an advanced AI-powered biomechanical analysis.
                                        Our system will automatically evaluate your cadence, stride length,
                                        vertical
                                        oscillation, ground contact time, and other key performance metrics to
                                        help
                                        you
                                        understand and improve your running technique.</p>
                                </div>

                                <!-- Upload Area -->
                                <div class="upload-area mb-4 mx-auto" id="runUploadArea" style="max-width: 500px;">
                                    <ion-icon name="cloud-upload-outline" class="upload-icon"></ion-icon>
                                    <h4 data-i18n="drop_video_text">Drop your video here</h4>
                                    <p class="text-secondary small" data-i18n="video_formats">Supports MP4, MOV,
                                        WEBM
                                        (Max 50MB)</p>
                                    <input type="file" id="runVideoInput" accept="video/*" class="d-none">
                                    <button class="btn btn-outline-primary mt-2" id="btnRunSelectFile"
                                        data-i18n="btn_select_file">Select File</button>
                                </div>



                                <!-- Analyze Button -->
                                <button type="button" class="btn btn-primary btn-md px-5 rounded-pill shadow-lg"
                                    id="btnAnalyzeRun" disabled>
                                    <ion-icon name="sparkles" class="me-2"></ion-icon>
                                    <span data-i18n="btn_analyze">Analyze with AI</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Analysis & Results Section (Hidden Initially) -->
                    <div id="runAnalysisSection" class="row d-none">
                        <!-- Left: Video Player -->
                        <div class="col-lg-6 mb-4">
                            <div class="glass-card p-0 overflow-hidden position-relative h-100"
                                style="min-height: 400px; background: black;">
                                <video id="runVideoPlayer" class="w-100 h-100 object-fit-cover" controls muted
                                    playsinline></video>
                                <canvas id="runCanvas" class="position-absolute top-0 start-0 w-100 h-100"
                                    style="pointer-events: none;"></canvas>
                                <!-- AI Overlay will be injected here via JS -->
                            </div>
                        </div>

                        <!-- Right: Results Panel -->
                        <div class="col-lg-6">
                            <div class="glass-card h-100" id="runResultContainer">
                                <div class="text-center h-100 d-flex flex-column justify-content-center align-items-center text-secondary"
                                    id="runResultPlaceholder">
                                    <ion-icon name="analytics-outline"
                                        style="font-size: 4rem; opacity: 0.5;"></ion-icon>
                                    <p class="mt-3">Analysis results will appear here.</p>
                                </div>
                                <div id="runResultBox" class="d-none animate-slide-in">
                                    <!-- Results injected by JS -->
                                </div>
                            </div>
                        </div>
                    </div>


                </div>

                <!-- 4. TRAINING PLAN (Legacy/Unused?) -->
                <div class="tab-pane fade" id="pro-plan-pane" role="tabpanel">
                    <div class="row g-4">
                        <div class="col-lg-4">
                            <div class="glass-card border-start border-4 border-primary">
                                <h5 class="text-white mb-3 text-primary"><ion-icon name="construct-outline"
                                        class="me-2"></ion-icon>Estructura Base</h5>
                                <div class="mb-3">
                                    <label class="form-label text-white-50 small">Días de
                                        Entrenamiento</label>
                                    <select id="proPlanDays" class="form-select bg-dark text-white border-secondary">
                                        <option value="3">3 días / semana</option>
                                        <option value="4" selected>4 días / semana</option>
                                        <option value="5">5 días / semana</option>
                                        <option value="6">6 días / semana</option>
                                    </select>
                                </div>
                                <div
                                    class="p-3 rounded bg-primary bg-opacity-10 border border-primary border-opacity-20">
                                    <p class="small text-white-50 mb-0">Esta estructura se adapta
                                        automáticamente a
                                        tu <strong>VAM (${currentVam} km/h)</strong> para definir ritmos de
                                        rodaje,
                                        series y tiradas largas.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <div id="manualPlanContainer" class="row g-3">
                                <!-- Injected by JS -->
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        </div>
        </div>
    </main>

    <!-- Zone Config Modal -->
    <div class="modal fade" id="zoneConfigModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-card border-0 p-0">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" data-i18n="zone_config_title">Zone Configuration</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-secondary small mb-4" data-i18n="zone_config_desc">Define Training Zones as % of VAM
                        Pace.</p>
                    <form id="zoneConfigForm">
                        <div class="mb-2 row align-items-center">
                            <label class="col-sm-3 col-form-label text-info fw-bold">Zone 1</label>
                            <div class="col-sm-4"><input type="number" class="form-control form-control-sm" id="z1_min"
                                    value="50"></div>
                            <div class="col-sm-1 text-center">-</div>
                            <div class="col-sm-4"><input type="number" class="form-control form-control-sm" id="z1_max"
                                    value="60"></div>
                        </div>
                        <div class="mb-2 row align-items-center">
                            <label class="col-sm-3 col-form-label text-success fw-bold">Zone 2</label>
                            <div class="col-sm-4"><input type="number" class="form-control form-control-sm" id="z2_min"
                                    value="60"></div>
                            <div class="col-sm-1 text-center">-</div>
                            <div class="col-sm-4"><input type="number" class="form-control form-control-sm" id="z2_max"
                                    value="70"></div>
                        </div>
                        <div class="mb-2 row align-items-center">
                            <label class="col-sm-3 col-form-label text-warning fw-bold">Zone 3</label>
                            <div class="col-sm-4"><input type="number" class="form-control form-control-sm" id="z3_min"
                                    value="70"></div>
                            <div class="col-sm-1 text-center">-</div>
                            <div class="col-sm-4"><input type="number" class="form-control form-control-sm" id="z3_max"
                                    value="80"></div>
                        </div>
                        <div class="mb-2 row align-items-center">
                            <label class="col-sm-3 col-form-label text-orange fw-bold" style="color:#fd7e14">Zone
                                4</label>
                            <div class="col-sm-4"><input type="number" class="form-control form-control-sm" id="z4_min"
                                    value="80"></div>
                            <div class="col-sm-1 text-center">-</div>
                            <div class="col-sm-4"><input type="number" class="form-control form-control-sm" id="z4_max"
                                    value="90"></div>
                        </div>
                        <div class="mb-2 row align-items-center">
                            <label class="col-sm-3 col-form-label text-danger fw-bold">Zone 5</label>
                            <div class="col-sm-4"><input type="number" class="form-control form-control-sm" id="z5_min"
                                    value="90"></div>
                            <div class="col-sm-1 text-center">-</div>
                            <div class="col-sm-4"><input type="number" class="form-control form-control-sm" id="z5_max"
                                    value="100"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal"
                        data-i18n="btn_cancel">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnSaveZones">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pro Zone Config Modal -->
    <div class="modal fade" id="proZoneConfigModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-card border-0 p-0">
                <div class="modal-header border-secondary border-opacity-25">
                    <h5 class="modal-title fw-bold text-white">Configurar Rangos % VAM</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-white-50 small mb-4">Ajusta los porcentajes de VAM para cada zona de entrenamiento.
                    </p>
                    <form id="proZoneConfigForm">
                        <div class="mb-3 row align-items-center">
                            <label class="col-sm-4 col-form-label text-info fw-bold small">Z1 - Recuperación</label>
                            <div class="col-sm-3"><input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="pro_z1_min" value="50"></div>
                            <div class="col-sm-1 text-center text-white-50">-</div>
                            <div class="col-sm-3"><input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="pro_z1_max" value="60"></div>
                            <div class="col-sm-1 text-white-50 small">%</div>
                        </div>
                        <div class="mb-3 row align-items-center">
                            <label class="col-sm-4 col-form-label text-success fw-bold small">Z2 - Rodaje Base</label>
                            <div class="col-sm-3"><input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="pro_z2_min" value="60"></div>
                            <div class="col-sm-1 text-center text-white-50">-</div>
                            <div class="col-sm-3"><input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="pro_z2_max" value="70"></div>
                            <div class="col-sm-1 text-white-50 small">%</div>
                        </div>
                        <div class="mb-3 row align-items-center">
                            <label class="col-sm-4 col-form-label text-primary fw-bold small">Z3 - Aeróbico</label>
                            <div class="col-sm-3"><input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="pro_z3_min" value="70"></div>
                            <div class="col-sm-1 text-center text-white-50">-</div>
                            <div class="col-sm-3"><input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="pro_z3_max" value="80"></div>
                            <div class="col-sm-1 text-white-50 small">%</div>
                        </div>
                        <div class="mb-3 row align-items-center">
                            <label class="col-sm-4 col-form-label text-warning fw-bold small">Z4 - Umbral</label>
                            <div class="col-sm-3"><input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="pro_z4_min" value="80"></div>
                            <div class="col-sm-1 text-center text-white-50">-</div>
                            <div class="col-sm-3"><input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="pro_z4_max" value="90"></div>
                            <div class="col-sm-1 text-white-50 small">%</div>
                        </div>
                        <div class="mb-3 row align-items-center">
                            <label class="col-sm-4 col-form-label text-danger fw-bold small">Z5 - VO2max</label>
                            <div class="col-sm-3"><input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="pro_z5_min" value="90"></div>
                            <div class="col-sm-1 text-center text-white-50">-</div>
                            <div class="col-sm-3"><input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="pro_z5_max" value="98"></div>
                            <div class="col-sm-1 text-white-50 small">%</div>
                        </div>
                        <div class="mb-3 row align-items-center">
                            <label class="col-sm-4 col-form-label text-secondary fw-bold small">Z6 - Anaeróbico</label>
                            <div class="col-sm-3"><input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="pro_z6_min" value="98"></div>
                            <div class="col-sm-1 text-center text-white-50">-</div>
                            <div class="col-sm-3"><input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="pro_z6_max" value="120"></div>
                            <div class="col-sm-1 text-white-50 small">%</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-secondary border-opacity-25">
                    <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary btn-sm" id="btnSaveProZones">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Common JS (Sidevar, i18n) -->
    <script src="js/common.js"></script>
    <!-- Video Processing JS -->
    <script src="js/video_processor.js"></script>
    <!-- Module JS -->
    <script src="js/running.js"></script>
    <script src="js/runner_pro.js"></script>

    <!-- React Component: Trail Nutrition Calculator -->
    <script type="text/babel">
        const { useState, useMemo } = React;

        // --- BASES DE DATOS DE PRODUCTOS ---
        const GELS = [
            { id: 'maurten100', name: 'Maurten Gel 100', cho: 25, na: 20 },
            { id: 'maurten160', name: 'Maurten Gel 160', cho: 40, na: 0 },
            { id: 'neversecond_c30', name: 'Neversecond C30', cho: 30, na: 200 },
            { id: '226ers_high', name: '226ERS High Energy', cho: 50, na: 0 },
            { id: 'santamadre', name: 'Santa Madre Unusual', cho: 60, na: 200 },
            { id: 'gu_roctane', name: 'GU Roctane', cho: 21, na: 180 },
            { id: 'gu_liquid', name: 'GU Liquid Energy', cho: 23, na: 40 },
            { id: 'sis_beta', name: 'SiS Beta Fuel', cho: 40, na: 30 },
            { id: 'precision30', name: 'Precision Fuel 30', cho: 30, na: 0 },
            { id: 'powerbar', name: 'PowerBar PowerGel', cho: 26, na: 200 },
            { id: 'clif_shot', name: 'Clif Shot Energy', cho: 24, na: 60 },
            { id: 'spring_cana', name: 'Spring Energy (Canaberry)', cho: 17, na: 60 },
            { id: 'huma_chia', name: 'Huma Chia Gel', cho: 23, na: 105 },
            { id: 'high5', name: 'High5 Energy Gel', cho: 23, na: 0 },
            { id: 'food_banana', name: 'Plátano (Medio)', cho: 23, na: 1 },
            { id: 'food_dates', name: 'Dátiles (3 uds)', cho: 18, na: 2 }
        ];

        const DRINKS = [
            { id: 'water', name: 'Agua Sola', cho: 0, na: 0 },
            { id: 'iso_generic', name: 'Isotónico Estándar', cho: 30, na: 250 }, // por 500ml
            { id: 'maurten320', name: 'Maurten Mix 320', cho: 80, na: 0 },
            { id: 'maurten160', name: 'Maurten Mix 160', cho: 40, na: 0 },
            { id: 'tailwind', name: 'Tailwind Nutrition', cho: 50, na: 600 },
            { id: 'tailwind_high_na', name: 'Tailwind High Sodium (Est)', cho: 50, na: 800 },
            { id: 'skratch', name: 'Skratch Labs Sport', cho: 20, na: 380 },
            { id: 'gatorade_endurance', name: 'Gatorade Endurance', cho: 22, na: 300 },
            { id: 'santamadre_carb', name: 'Santa Madre Carbofuel', cho: 45, na: 400 },
            { id: 'nuun', name: 'Nuun Sport (Electrolitos)', cho: 1, na: 300 },
            { id: 'ph_1000', name: 'Precision Hydration 1000', cho: 1, na: 500 },
            { id: 'ph_1500', name: 'Precision Hydration 1500', cho: 1, na: 750 },
            { id: 'salt_stick', name: 'Salt Stick Caps (1 cap/h)', cho: 0, na: 215 },
        ];

        const TrailMasterV4 = () => {
            // --- 1. VARIABLES DE ENTRADA (ESTADO) ---

            // Perfil Atleta
            const [weight, setWeight] = useState(70); // kg
            const [gutTraining, setGutTraining] = useState('medium'); // low, medium, high
            const [sweatLevel, setSweatLevel] = useState('medium'); // low, medium, high, extreme

            // Perfil Carrera
            const [dist, setDist] = useState(21); // km
            const [elev, setElev] = useState(1000); // m+
            const [timeH, setTimeH] = useState(3); // horas
            const [terrain, setTerrain] = useState('mixed'); // runnable, mixed, technical

            // Condiciones
            const [temp, setTemp] = useState(20); // Celsius
            const [altitude, setAltitude] = useState(1000); // metros promedio

            // Estrategia Nutricional
            const [selectedGel, setSelectedGel] = useState('maurten100');
            const [selectedDrink, setSelectedDrink] = useState('iso_generic');
            const [liquidIntake, setLiquidIntake] = useState(500); // ml/hora objetivo

            // --- 2. MOTOR DE CÁLCULO CIENTÍFICO ---

            const results = useMemo(() => {
                const warnings = [];

                // A. CÁLCULO DE ESFUERZO (ITRA & COSTO ENERGÉTICO)
                // Km Esfuerzo = Dist + (Desnivel/100)
                const kmEffort = dist + (elev / 100);

                // Coeficiente de Terreno (Energy Cost)
                // Technical: Más frenadas/arrancadas = Mayor gasto (1.2 - 1.3 kcal/kg/km)
                // Runnable: Ritmo constante = Eficiencia estándar (1.0 kcal/kg/km)
                let terrainCoeff = 1.05; // Mixed base
                if (terrain === 'technical') terrainCoeff = 1.25;
                if (terrain === 'runnable') terrainCoeff = 0.98;

                // Gasto Calórico Total
                // Fórmula: Peso * KmEsfuerzo * CoeficienteTerreno
                const totalKcal = Math.round(weight * kmEffort * terrainCoeff);
                const kcalPerHour = Math.round(totalKcal / timeH);

                // B. DEMANDA DE CARBOHIDRATOS (CHO)
                // Base fisiológica según duración
                let targetCHO = 0;
                if (timeH <= 1.5) targetCHO = 30;
                else if (timeH <= 2.5) targetCHO = 60;
                else targetCHO = 90; // Estándar Ultra moderno

                // Ajuste por Intensidad Relativa
                // Si Kcal/h es muy alto para el peso, es alta intensidad -> Necesita más CHO
                const relativeIntensity = kcalPerHour / weight; // kcal/kg/h
                if (relativeIntensity > 10) targetCHO += 10; // Intensidad alta

                // Límite por Entreno Estomacal (Gut Training)
                let gutLimit = 60;
                if (gutTraining === 'medium') gutLimit = 90;
                if (gutTraining === 'high') gutLimit = 120;

                // Ajuste por Rebote Estomacal (Terrain Bouncing)
                // En terreno muy "corrible", el rebote mecánico dificulta la digestión de altos volúmenes
                if (terrain === 'runnable' && targetCHO > 75) {
                    gutLimit -= 10;
                    warnings.push("Terreno muy corrible: Se reduce el límite de ingesta por alto impacto mecánico (rebote).");
                }

                // Aplicar Límite Estomacal
                targetCHO = Math.min(targetCHO, gutLimit);

                // C. PENALIZACIONES AMBIENTALES
                // Calor: La sangre va a la piel para termoregulación, isquemia intestinal.
                let envFactor = 1.0;
                if (temp > 25) envFactor -= 0.15; // -15% absorción
                if (temp > 32) envFactor -= 0.25; // -25% absorción

                // Altitud: Hipoxia reduce flujo sanguíneo digestivo
                if (altitude > 2000) envFactor -= 0.10;
                if (altitude > 3000) envFactor -= 0.20;

                const adjustedCHO = Math.round(targetCHO * envFactor);
                if (adjustedCHO < targetCHO) {
                    warnings.push(`Ambiente hostil (Calor/Altitud): Objetivo reducido a ${adjustedCHO}g/h para evitar bloqueo gástrico.`);
                }

                // D. HIDRATACIÓN Y SODIO
                // Mapeo Tasa Sudoración (L/h)
                const sweatMap = {
                    low: 0.5,     // < 15C o ritmo suave
                    medium: 1.0,  // Estándar
                    high: 1.5,    // Calor o alta intensidad
                    extreme: 2.0  // Competición en calor
                };
                let sweatRate = sweatMap[sweatLevel];
                // Ajuste fino por temperatura si no se seleccionó manualmente
                if (temp > 28 && sweatLevel === 'medium') sweatRate = 1.3;

                const fluidLoss = sweatRate * 1000; // ml/h
                const fluidBalance = liquidIntake - fluidLoss; // Si es negativo, deshidratación

                // Mapeo Sodio (mg/L de sudor promedio ~900mg)
                const naLoss = sweatRate * 900;

                // E. CÁLCULO DE PRODUCTO (LA MEZCLA)
                const drinkInfo = DRINKS.find(d => d.id === selectedDrink);
                const gelInfo = GELS.find(g => g.id === selectedGel);

                // Aporte del Líquido
                const liquidCHO_h = (drinkInfo.cho / 500) * liquidIntake;
                const liquidNa_h = (drinkInfo.na / 500) * liquidIntake;

                // Aporte Restante necesario de Geles
                let remainingCHO = adjustedCHO - liquidCHO_h;
                if (remainingCHO < 0) remainingCHO = 0;

                const gelsNeeded = gelInfo.cho > 0 ? (remainingCHO / gelInfo.cho) : 0;
                const totalGels = Math.ceil(gelsNeeded * timeH);
                const gelInterval = gelsNeeded > 0 ? Math.round(60 / gelsNeeded) : 0;

                // Total Sodio Ingesta
                const totalNa_Input = liquidNa_h + (gelsNeeded * gelInfo.na);

                // F. OSMOLARIDAD (CRÍTICO)
                // Concentración (%) = (Total CHO g / Total Líquido ml) * 100
                // Rango ideal: 6-8% (Isotónico). Máximo tolerable: 10-12% (Hipertónico - riesgo diarrea)
                const totalCHO_Input = liquidCHO_h + (gelsNeeded * gelInfo.cho);
                const concentration = liquidIntake > 0 ? (totalCHO_Input / liquidIntake) * 100 : 100;

                return {
                    kmEffort,
                    totalKcal,
                    kcalPerHour,
                    targetCHO: adjustedCHO,
                    liquidCHO_h,
                    gelsNeeded: gelsNeeded.toFixed(1),
                    totalGels,
                    gelInterval,
                    fluidLoss,
                    fluidBalance,
                    naLoss,
                    totalNa_Input,
                    concentration: concentration.toFixed(1),
                    warnings
                };
            }, [weight, gutTraining, sweatLevel, dist, elev, timeH, terrain, temp, altitude, selectedGel, selectedDrink, liquidIntake]);

            // Función auxiliar para colores
            const getOsmolarityColor = (val) => {
                if (val < 4) return 'text-blue-400'; // Hipo
                if (val <= 8) return 'text-emerald-400'; // Iso (Perfecto)
                if (val <= 12) return 'text-amber-400'; // Límite (Relaxed from 11)
                return 'text-red-500'; // Peligro (>12%)
            };

            return (
                <div className="max-w-7xl mx-auto p-4 lg:p-8 min-h-screen animate-slide-in">



                    <div className="flex justify-center mb-6">
                        <button className="bg-slate-800/50 hover:bg-slate-700 text-slate-300 text-xs px-4 py-2 rounded-full border border-white/10 flex items-center gap-2 transition-all" data-bs-toggle="modal" data-bs-target="#nutritionMethodologyModal">
                            <ion-icon name="book-outline"></ion-icon>
                            <span>Cómo funciona & Base Científica</span>
                        </button>
                    </div>




                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">

                        {/* --- COLUMNA DE DATOS (INPUTS) --- */}
                        <div className="lg:col-span-4 space-y-6">

                            {/* SECCIÓN 1: FÍSICA DEL RECORRIDO */}
                            <section className="panel p-5">
                                <h2 className="label text-blue-400 mb-4 border-b border-white/5 pb-2">1. Física del Terreno</h2>
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <span className="text-xs text-slate-400 mb-1 block">Distancia (km)</span>
                                            <input type="number" value={dist} onChange={e => setDist(Number(e.target.value))} className="input-dark" />
                                        </div>
                                        <div>
                                            <span className="text-xs text-slate-400 mb-1 block">Desnivel + (m)</span>
                                            <input type="number" value={elev} onChange={e => setElev(Number(e.target.value))} className="input-dark" />
                                        </div>
                                    </div>
                                    <div>
                                        <span className="text-xs text-slate-400 mb-1 block">Duración Estimada (h)</span>
                                        <input type="number" step="0.5" value={timeH} onChange={e => setTimeH(Number(e.target.value))} className="input-dark" />
                                    </div>
                                    <div>
                                        <span className="text-xs text-slate-400 mb-1 block">Tipo de Terreno</span>
                                        <select value={terrain} onChange={e => setTerrain(e.target.value)} className="input-dark cursor-pointer">
                                            <option value="runnable">Corrible / Pista (Alto Impacto/Rebote)</option>
                                            <option value="mixed">Mixto / Sendero (Estándar)</option>
                                            <option value="technical">Técnico / Skyrunning (Alto Gasto Energético)</option>
                                        </select>
                                        <p className="text-[10px] text-slate-500 mt-1">
                                            {terrain === 'technical' ? 'Aumenta el cálculo calórico un 20%.' : terrain === 'runnable' ? 'Reduce tolerancia gástrica por rebote.' : 'Balance estándar.'}
                                        </p>
                                    </div>
                                </div>
                            </section>

                            {/* SECCIÓN 2: FISIOLOGÍA Y AMBIENTE */}
                            <section className="panel p-5">
                                <h2 className="label text-emerald-400 mb-4 border-b border-white/5 pb-2">2. Fisiología & Clima</h2>
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <span className="text-xs text-slate-400 mb-1 block">Peso (kg)</span>
                                            <input type="number" value={weight} onChange={e => setWeight(Number(e.target.value))} className="input-dark" />
                                        </div>
                                        <div>
                                            <span className="text-xs text-slate-400 mb-1 block">Temperatura (°C)</span>
                                            <input type="number" value={temp} onChange={e => setTemp(Number(e.target.value))} className="input-dark" />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <span className="text-xs text-slate-400 mb-1 block">Entreno Estómago</span>
                                            <select value={gutTraining} onChange={e => setGutTraining(e.target.value)} className="input-dark text-xs">
                                                <option value="low">Bajo (Max 60g)</option>
                                                <option value="medium">Medio (Max 90g)</option>
                                                <option value="high">Élite (Max 120g)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <span className="text-xs text-slate-400 mb-1 block">Altitud Media (m)</span>
                                            <input type="number" value={altitude} onChange={e => setAltitude(Number(e.target.value))} className="input-dark" />
                                        </div>
                                    </div>
                                    <div>
                                        <span className="text-xs text-slate-400 mb-1 block">Tasa Sudoración (Subjetiva)</span>
                                        <div className="grid grid-cols-4 gap-1">
                                            {['low', 'medium', 'high', 'extreme'].map(level => (
                                                <button
                                                    key={level}
                                                    onClick={() => setSweatLevel(level)}
                                                    className={`text-[10px] py-2 rounded border ${sweatLevel === level ? 'bg-blue-600 border-blue-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'}`}
                                                >
                                                    {level === 'low' ? 'Baja' : level === 'medium' ? 'Media' : level === 'high' ? 'Alta' : 'Extrema'}
                                                </button>
                                            ))}
                                        </div>
                                        <p className="text-[10px] text-right text-slate-500 mt-1">
                                            Est: {level => level === 'low' ? 0.5 : level === 'medium' ? 1.0 : level === 'high' ? 1.5 : 2.0} L/h
                                        </p>
                                    </div>
                                </div>
                            </section>

                            {/* SECCIÓN 3: ESTRATEGIA */}
                            <section className="panel p-5">
                                <h2 className="label text-amber-400 mb-4 border-b border-white/5 pb-2">3. Estrategia de Fuel</h2>
                                <div className="space-y-4">
                                    <div>
                                        <span className="text-xs text-slate-400 mb-1 block">Bebida (Fuente Líquida)</span>
                                        <select value={selectedDrink} onChange={e => setSelectedDrink(e.target.value)} className="input-dark text-xs">
                                            {DRINKS.map(d => <option key={d.id} value={d.id}>{d.name} ({d.cho}g CHO/500ml)</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <div className="flex justify-between">
                                            <span className="text-xs text-slate-400 mb-1 block">Plan de Hidratación (ml/h)</span>
                                            <span className="text-xs font-bold text-blue-400">{liquidIntake} ml</span>
                                        </div>
                                        <input type="range" min="0" max="1500" step="50" value={liquidIntake} onChange={e => setLiquidIntake(Number(e.target.value))} className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500" />
                                    </div>
                                    <div>
                                        <span className="text-xs text-slate-400 mb-1 block">Gel / Sólido Preferido</span>
                                        <select value={selectedGel} onChange={e => setSelectedGel(e.target.value)} className="input-dark text-xs">
                                            {GELS.map(g => <option key={g.id} value={g.id}>{g.name} ({g.cho}g CHO)</option>)}
                                        </select>
                                    </div>
                                </div>
                            </section>
                        </div>

                        {/* --- COLUMNA DE RESULTADOS (OUTPUT) --- */}
                        <div className="lg:col-span-8 space-y-6">

                            {/* KPI CARDS SUPERIOR */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="panel p-4 flex flex-col justify-between">
                                    <div>
                                        <span className="label text-slate-500">Km Esfuerzo (ITRA)</span>
                                        <span className="text-3xl font-bold text-white">{results.kmEffort.toFixed(1)} <span className="text-sm font-normal text-slate-500">km</span></span>
                                    </div>
                                    <div className="text-[10px] text-slate-500 mt-2">Dureza Real Física</div>
                                </div>
                                <div className="panel p-4 flex flex-col justify-between">
                                    <div>
                                        <span className="label text-slate-500">Gasto Calórico</span>
                                        <span className="text-3xl font-bold text-white">{results.kcalPerHour} <span className="text-sm font-normal text-slate-500">kcal/h</span></span>
                                    </div>
                                    <div className="text-[10px] text-slate-500 mt-2">Total: {results.totalKcal} kcal</div>
                                </div>
                                <div className="panel p-4 flex flex-col justify-between border-l-2 border-blue-500">
                                    <div>
                                        <span className="label text-blue-400">Objetivo CHO/h</span>
                                        <span className="text-3xl font-bold text-white">{results.targetCHO} <span className="text-sm font-normal text-slate-500">g/h</span></span>
                                    </div>
                                    <div className="text-[10px] text-slate-500 mt-2">Ajustado por clima y terreno</div>
                                </div>
                            </div>

                            {/* PLAN PRINCIPAL */}
                            <div className="panel bg-gradient-to-br from-slate-800 to-slate-900 border-slate-700 shadow-xl overflow-hidden relative">
                                <div className="p-6 md:p-8 relative z-10">
                                    <h3 className="text-lg font-bold text-white mb-6 flex items-center gap-2">
                                        <svg className="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                                        Estrategia de Ejecución
                                    </h3>

                                    <div className="flex flex-col md:flex-row gap-8 items-center">
                                        <div className="flex-1 text-center md:text-left">
                                            <div className="text-sm text-slate-400 uppercase tracking-wide mb-1">Ritmo de Ingesta</div>
                                            {parseFloat(results.gelsNeeded) > 0 ? (
                                                <>
                                                    <div className="text-5xl font-black text-white leading-none mb-2">{results.gelsNeeded} <span className="text-lg font-medium text-slate-400">geles/h</span></div>
                                                    <div className="inline-block bg-slate-700/50 rounded-lg px-3 py-1 text-sm text-emerald-300 font-mono border border-slate-600">
                                                        1 gel cada {results.gelInterval} minutos
                                                    </div>
                                                </>
                                            ) : (
                                                <div className="text-2xl font-bold text-emerald-400">Solo Líquido es suficiente</div>
                                            )}
                                        </div>

                                        <div className="w-px h-24 bg-slate-700 hidden md:block"></div>

                                        <div className="flex-1 space-y-3">
                                            <div className="flex justify-between items-center text-sm">
                                                <span className="text-slate-400">Total Geles Carrera:</span>
                                                <span className="font-bold text-white text-lg">{results.totalGels} uds</span>
                                            </div>
                                            <div className="flex justify-between items-center text-sm">
                                                <span className="text-slate-400">Total Litros:</span>
                                                <span className="font-bold text-white text-lg">{(liquidIntake * timeH / 1000).toFixed(1)} L</span>
                                            </div>
                                            <div className="flex justify-between items-center text-sm pt-2 border-t border-white/5">
                                                <span className="text-slate-400">Carbohidratos Líquidos:</span>
                                                <span className="font-mono text-blue-300">{Math.round(results.liquidCHO_h)} g/h</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* PANELES DE SEGURIDAD CIENTÍFICA */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">

                                {/* 1. OSMOLARIDAD (Digestión) */}
                                <div className="panel p-5">
                                    <div className="flex justify-between items-start mb-4">
                                        <h3 className="label text-slate-300">Tolerancia Gástrica (Osmolaridad)</h3>
                                        <div className={`text-xl font-bold font-mono ${getOsmolarityColor(parseFloat(results.concentration))}`}>
                                            {results.concentration}%
                                        </div>
                                    </div>

                                    {/* Gauge Bar */}
                                    <div className="relative h-3 bg-slate-800 rounded-full overflow-hidden mb-2">
                                        <div className="absolute top-0 bottom-0 left-[60%] w-0.5 bg-white/20 z-10" title="Ideal min"></div>
                                        <div className="absolute top-0 bottom-0 left-[80%] w-0.5 bg-white/20 z-10" title="Ideal max"></div>
                                        <div
                                            className={`h-full transition-all duration-500 ${getOsmolarityColor(parseFloat(results.concentration)).replace('text', 'bg').replace('400', '500')}`}
                                            style={{ width: `${Math.min(parseFloat(results.concentration) * 10, 100)}%` }}
                                        ></div>
                                    </div>
                                    <div className="flex justify-between text-[10px] text-slate-500 mb-3">
                                        <span>0%</span>
                                        <span className="text-emerald-500 font-bold">6-8% (Óptimo)</span>
                                        <span>12%+</span>
                                    </div>

                                    {parseFloat(results.concentration) > 12 ? (
                                        <div className="p-3 bg-red-900/20 border border-red-900/50 rounded text-xs text-red-200 leading-snug">
                                            ⚠️ <strong>Concentración Alta:</strong> Mezcla muy concentrada. Puede causar molestias estomacales. Bebe agua extra.
                                        </div>
                                    ) : parseFloat(results.concentration) < 4 && results.targetCHO > 40 ? (
                                        <div className="p-3 bg-blue-900/20 border border-blue-900/50 rounded text-xs text-blue-200 leading-snug">
                                            ℹ️ <strong>Hipotónico:</strong> Mezcla muy diluida. Hidratación rápida, pero poca energía. Considera añadir CHO.
                                        </div>
                                    ) : (
                                        <div className="p-3 bg-emerald-900/20 border border-emerald-900/50 rounded text-xs text-emerald-200 leading-snug">
                                            ✅ <strong>Isotónico:</strong> Mezcla perfecta para vaciado gástrico rápido y absorción de energía.
                                        </div>
                                    )}
                                </div>

                                {/* 2. BALANCE HÍDRICO & SODIO */}
                                <div className="panel p-5">
                                    <h3 className="label text-slate-300 mb-4">Balance Hidroelectrolítico</h3>

                                    <div className="space-y-4">
                                        {/* Agua */}
                                        <div>
                                            <div className="flex justify-between text-xs text-slate-400 mb-1">
                                                <span>Agua (Pérdida vs Ingesta)</span>
                                                <span className={results.fluidBalance < -600 ? 'text-red-400' : 'text-emerald-400'}>
                                                    {Math.round(results.fluidBalance)} ml/h
                                                </span>
                                            </div>
                                            <div className="h-2 bg-slate-800 rounded-full overflow-hidden flex relative">
                                                <div className="bg-red-500/50 h-full w-full absolute"></div>
                                                <div className="bg-blue-500 h-full absolute transition-all duration-500" style={{ width: `${Math.min((liquidIntake / results.fluidLoss) * 100, 100)}%` }}></div>
                                            </div>
                                            <div className="text-[10px] text-right text-slate-500 mt-1">
                                                Pierdes {results.fluidLoss.toFixed(0)}ml/h
                                            </div>
                                        </div>

                                        {/* Sodio */}
                                        <div className="pt-2 border-t border-white/5">
                                            <div className="flex justify-between items-baseline mb-1">
                                                <span className="text-xs text-slate-400">Sodio Ingesta</span>
                                                <span className="font-mono text-white font-bold">{Math.round(results.totalNa_Input)} mg</span>
                                            </div>
                                            <div className="flex justify-between items-baseline">
                                                <span className="text-xs text-slate-400">Sodio Estimado Pérdida</span>
                                                <span className="font-mono text-slate-500">{Math.round(results.naLoss)} mg</span>
                                            </div>
                                            {(results.totalNa_Input - results.naLoss) < -700 && (
                                                <div className="mt-2 text-[10px] text-amber-400 flex items-center gap-1">
                                                    <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                                                    Aporte bajo de Sodio. Considera añadir sales.
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* ALERTAS GLOBALES */}
                            {results.warnings.length > 0 && (
                                <div className="space-y-2">
                                    {results.warnings.map((w, i) => (
                                        <div key={i} className="bg-amber-900/20 border border-amber-900/50 p-3 rounded flex items-start gap-3">
                                            <svg className="w-5 h-5 text-amber-500 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                                            <span className="text-xs text-amber-200">{w}</span>
                                        </div>
                                    ))}
                                </div>
                            )}

                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('trail-nutrition-root'));
        root.render(<TrailMasterV4 />);
    </script>


    <!-- Nutrition Methodology Modal -->
    <div class="modal fade" id="nutritionMethodologyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content glass-card border-0 p-0 text-white">
                <div class="modal-header border-secondary border-opacity-25">
                    <h5 class="modal-title fw-bold"><ion-icon name="flask-outline"
                            class="me-2 text-info"></ion-icon>Metodología Científica</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <h6 class="text-primary fw-bold mb-2">1. Demanda de Carbohidratos (CHO)</h6>
                            <p class="small text-white-50">Basado en las guías de la <em>International Society of Sports
                                    Nutrition (ISSN)</em>:</p>
                            <ul class="small text-white-50 ps-3">
                                <li><strong>&lt; 90 min:</strong> 30g/h (Reservas de glucógeno suficientes).</li>
                                <li><strong>90 - 150 min:</strong> 60g/h (Glucosa).</li>
                                <li><strong>&gt; 150 min (Ultra):</strong> 90-120g/h (Glucosa + Fructosa 2:1).</li>
                                <li>Ajustes por Intensidad (RPE), Calor y Tolerancia Gástrica.</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-info fw-bold mb-2">2. Hidratación & Osmolaridad</h6>
                            <p class="small text-white-50">Cálculo de <strong>Isotonicidad</strong> para optimizar el
                                vaciado gástrico:</p>
                            <ul class="small text-white-50 ps-3">
                                <li>Concentración ideal: <strong>6-8%</strong> (Isotónico).</li>
                                <li><strong>&gt;10% (Hipertónico):</strong> Riesgo de problemas GI. Se requiere más agua
                                    para diluir los geles.</li>
                                <li>La tasa de sudoración se estima según peso, temperatura y nivel de sudoración
                                    subjetivo.</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success fw-bold mb-2">3. Sodio (Electrolitos)</h6>
                            <p class="small text-white-50">Reposición crítica para evitar la hiponatremia:</p>
                            <ul class="small text-white-50 ps-3">
                                <li>Baja sudoración: ~400mg/h.</li>
                                <li>Alta sudoración/Calor: ~800-1200mg/h.</li>
                                <li>Se descuenta el sodio aportado por la bebida y geles seleccionados.</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-warning fw-bold mb-2">4. Estrategia de Fueling</h6>
                            <p class="small text-white-50">El algoritmo prioriza:</p>
                            <ol class="small text-white-50 ps-3">
                                <li>Cubrir la demanda de líquido con Isotónico (Base).</li>
                                <li>Completar la demanda de CHO restante con Geles.</li>
                                <li>Verificar que la mezcla estomacal no sea hipertónica.</li>
                            </ol>
                        </div>
                        <div class="col-12">
                            <h6 class="text-white fw-bold mb-3 border-bottom border-white-10 pb-2">5. Glosario de
                                Variables (Input)</h6>
                            <div class="table-responsive">
                                <table class="table table-dark table-sm table-borderless small text-white-50 mb-0">
                                    <thead>
                                        <tr>
                                            <th class="text-white">Variable</th>
                                            <th class="text-white">Impacto en el Cálculo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="text-info">Peso</td>
                                            <td>Afecta la tasa de sudoración estimada y el gasto calórico basal.</td>
                                        </tr>
                                        <tr>
                                            <td class="text-info">Duración</td>
                                            <td>Determina el rango de CHO: &lt;1.5h (30g), 1.5-2.5h (60g), &gt;2.5h
                                                (75-90g).</td>
                                        </tr>
                                        <tr>
                                            <td class="text-info">Intensidad (RPE)</td>
                                            <td>RPE &gt; 8 aumenta la demanda de CHO (+10g/h) por mayor uso de
                                                glucógeno.</td>
                                        </tr>
                                        <tr>
                                            <td class="text-info">Terreno</td>
                                            <td>Técnico (lento) favorece digestión. Corrible (rebote) limita la
                                                tolerancia a sólidos.</td>
                                        </tr>
                                        <tr>
                                            <td class="text-info">Temperatura</td>
                                            <td>&gt; 25°C incrementa necesidades de fluido (+200-300ml/h) y reduce
                                                tolerancia a CHO (-15%).</td>
                                        </tr>
                                        <tr>
                                            <td class="text-info">Nivel Estómago</td>
                                            <td>Define el límite máximo de absorción (60g, 75g, o 90g+).</td>
                                        </tr>
                                        <tr>
                                            <td class="text-info">Sudoración</td>
                                            <td>Baja/Media/Alta define la pérdida de sodio (400/800/1200 mg/h) y agua.
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-info">Volumen Líquido</td>
                                            <td>Clave para la Osmolaridad. Menos agua = Mayor concentración = Riesgo GI.
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary border-opacity-25">
                    <p class="small text-secondary me-auto mb-0">Algoritmo v2.1 | DataGym Science</p>
                    <button type="button" class="btn btn-outline-light btn-sm"
                        data-bs-dismiss="modal">Entendido</button>
                </div>
            </div>
        </div>
    </div>
    </div>
</body>

</html>