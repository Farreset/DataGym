
// Swimming Module Logic - Refactored
// Ported from React/Tailwind to Vanilla/Bootstrap by Gemini Agent

// --- Constants ---
const STYLE_FACTORS = {
    freestyle: 1.00,
    butterfly: 1.10,
    backstroke: 1.12,
    breaststroke: 1.25
};

// Factors for "Estimate" mode (100m -> CSS Pace)
const ATHLETE_PROFILES = {
    sprinter: 1.15,   // CSS is ~15% slower than 100m max
    mixed: 1.10,      // CSS is ~10% slower
    distance: 1.06    // CSS is ~6% slower (efficient)
};

const ZONES = {
    rec: { nameKey: "Recuperación (Rec)", label: "Rec", factorMin: 1.33, factorMax: 1.53, descKey: "Eliminación de lactato, recuperación activa.", color: "info", lactate: "< 1.5 mM" },
    en1: { nameKey: "Resistencia Base (En-1)", label: "En-1", factorMin: 1.17, factorMax: 1.33, descKey: "Capacidad aeróbica, quema de grasas. Volúmenes largos.", color: "success", lactate: "~ 2.0 mM" },
    en2: { nameKey: "Umbral Anaeróbico (En-2)", label: "En-2", factorMin: 1.11, factorMax: 1.17, descKey: "Estado estable de lactato. Ritmo de crucero fuerte.", color: "warning", lactate: "~ 4.0 mM" },
    en3: { nameKey: "Potencia Aeróbica (VO2max)", label: "En-3", factorMin: 1.00, factorMax: 1.11, descKey: "Máximo consumo de oxígeno. Series cortas (50-200m).", color: "orange", lactate: "~ 6.0 mM" },
    sp: { nameKey: "Sprint / Potencia (Sp)", label: "Sprint", factorMin: 0.85, factorMax: 0.95, descKey: "Velocidad pura y tolerancia láctica extrema.", color: "danger", lactate: "> 8.0 mM" }
};

// --- State ---
let swimState = {
    cssSpeed: 0, // m/s
    cssPace: 0,  // seconds per 100m
    athleteProfile: 'mixed',
    cssMode: 'test' // 'test' or 'estimate'
};

document.addEventListener('DOMContentLoaded', () => {
    // Initialize AI Video Upload (Existing logic)
    setupFileUpload({
        zoneId: 'swimUploadArea',
        inputId: 'swimVideoInput',
        btnId: 'btnSwimSelectFile',
        resultBoxId: 'swimResultBox',
        mockId: 'aiOutputMock',
        videoId: 'swimVideoPlayer',
        canvasId: 'swimCanvas',
        analyzeBtnId: 'btnAnalyzeSwim',
        module: 'Swimming',
        onAnalysisComplete: handleAIAnalysis,
        onUploadStart: () => {
            document.getElementById('swimResultBox').classList.add('d-none');
            document.getElementById('swimVideoContainer').classList.remove('d-none');
            document.getElementById('swimAiOverlay').classList.remove('d-none');
            document.getElementById('swimUploadArea').classList.add('d-none');
        }
    });

    // Initialize Sub-modules
    initCssProfile();
    initZones();
    initWorkoutBuilder();
    initSwolf();
    initAcwr();

    // Set default mode UI
    switchCssMode('test');
});

// --- 1. CSS Profile ---
function initCssProfile() {
    // Test Mode Calculation
    const btnTest = document.getElementById('btnCalcCSS_Test');
    if (btnTest) {
        btnTest.addEventListener('click', () => {
            // Get 400m time
            const t400_m = parseInt(document.getElementById('cssT400m').value) || 0;
            const t400_s = parseInt(document.getElementById('cssT400s').value) || 0;
            const t400_total = (t400_m * 60) + t400_s;

            // Get 200m time
            const t200_m = parseInt(document.getElementById('cssT200m').value) || 0;
            const t200_s = parseInt(document.getElementById('cssT200s').value) || 0;
            const t200_total = (t200_m * 60) + t200_s;

            if (t400_total <= 0 || t200_total <= 0 || t400_total <= t200_total) {
                alert("Por favor revisa los tiempos. El 400m debe ser mayor que el 200m.");
                return;
            }

            // CSS Formula (m/s) = (D2 - D1) / (T2 - T1)
            const speed = (400 - 200) / (t400_total - t200_total);
            const pace100 = 100 / speed;

            updateCssResults(speed, pace100, "Basado en Test Real (400/200)");
        });
    }

    // Estimate Mode Calculation
    const btnEst = document.getElementById('btnCalcCSS_Est');
    if (btnEst) {
        btnEst.addEventListener('click', () => {
            // Get 100m Time
            const t100_m = parseInt(document.getElementById('cssT100m').value) || 0;
            const t100_s = parseInt(document.getElementById('cssT100s').value) || 0;
            const t100_total = (t100_m * 60) + t100_s;

            if (t100_total <= 0) {
                alert("Por favor introduce un tiempo válido para 100m.");
                return;
            }

            // Get Profile
            const profileEls = document.getElementsByName('athleteProfile');
            let selectedProfile = 'mixed';
            profileEls.forEach(el => { if (el.checked) selectedProfile = el.value; });

            // Calculate CSS Pace
            const factor = ATHLETE_PROFILES[selectedProfile];
            const pace100 = t100_total * factor;
            const speed = 100 / pace100;

            updateCssResults(speed, pace100, `Estimado (${capitalize(selectedProfile)})`);
        });
    }

    // Trigger update on profile change (visual feedback only)
    const profileRadios = document.getElementsByName('athleteProfile');
    profileRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            const desc = document.getElementById('profileDesc');
            if (e.target.value === 'sprinter') desc.textContent = "Excelente velocidad pura, menor resistencia aeróbica.";
            else if (e.target.value === 'distance') desc.textContent = "Gran motor aeróbico, menor explosividad.";
            else desc.textContent = "Equilibrio ideal velocidad/resistencia.";
        });
    });
}

function switchCssMode(mode) {
    swimState.cssMode = mode;
    const divTest = document.getElementById('divCssTestMode');
    const divEst = document.getElementById('divCssEstMode');
    const btnTest = document.getElementById('btnModeTest');
    const btnEst = document.getElementById('btnModeEst');

    if (mode === 'test') {
        divTest.classList.remove('d-none');
        divEst.classList.add('d-none');
        btnTest.classList.add('active-mode-btn', 'text-dark');
        btnTest.classList.remove('text-secondary');
        btnEst.classList.remove('active-mode-btn', 'text-dark');
        btnEst.classList.add('text-secondary');
    } else {
        divTest.classList.add('d-none');
        divEst.classList.remove('d-none');
        btnEst.classList.add('active-mode-btn', 'text-dark');
        btnEst.classList.remove('text-secondary');
        btnTest.classList.remove('active-mode-btn', 'text-dark');
        btnTest.classList.add('text-secondary');
    }
}

function updateCssResults(speed, pace100, methodLabel) {
    swimState.cssSpeed = speed;
    swimState.cssPace = pace100;

    document.getElementById('resCssSpeed').textContent = speed.toFixed(2);
    document.getElementById('resCssPace').textContent = formatMinSec(pace100);
    document.getElementById('cssPlaceholder').classList.add('d-none');
    document.getElementById('cssResults').classList.remove('d-none');
    document.getElementById('cssMethodLabel').textContent = methodLabel;

    // Auto Update Zones
    updateZonesTable();
}


// --- 2. Zones & Styles ---
function initZones() {
    const select = document.getElementById('selZoneStyle');
    if (select) {
        select.addEventListener('change', updateZonesTable);
    }
}

function updateZonesTable() {
    const container = document.getElementById('zonesTableContainer');
    if (!swimState.cssPace || swimState.cssPace === 0) return;

    const style = document.getElementById('selZoneStyle').value;
    const factor = STYLE_FACTORS[style];
    const basePace = swimState.cssPace * factor;

    let html = '';

    Object.entries(ZONES).forEach(([key, zone]) => {
        const tMin = basePace * zone.factorMax; // Slower time limit (lower exertion?? No, higher factor means slower)
        // Wait, factorMin/Max in ZONES are pace multipliers. 
        // En1: 1.17 - 1.33. Pace x 1.33 is SLOWER than Pace x 1.17.
        // So tMaxTime (slowest) is factorMax. tMinTime (fastest) is factorMin.
        const tSlow = basePace * zone.factorMax;
        const tFast = basePace * zone.factorMin;

        // Colors
        let borderColor = `border-${zone.color}`;
        let bgColor = `bg-${zone.color}`;
        let textColor = `text-${zone.color}`;
        let bgStyle = 'style="--bs-bg-opacity: .1;"';
        let textStyle = '';

        // Orange fix for bootstrap
        if (zone.color === 'orange') {
            borderColor = 'border-warning';
            bgColor = 'bg-warning';
            textColor = 'text-warning';
            bgStyle = 'style="--bs-bg-opacity: .1; border-color: #fd7e14 !important;"';
            textStyle = 'style="color: #fd7e14 !important;"';
        }

        const name = (typeof getTranslation === 'function' ? getTranslation(zone.nameKey) : zone.label);
        const desc = (typeof getTranslation === 'function' ? getTranslation(zone.descKey) : "Training Zone");

        html += `
            <div class="glass-card mb-3 p-3 border-start border-5 ${borderColor} ${bgColor}" ${bgStyle}>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="fw-bold mb-1 ${textColor}" ${textStyle}>
                            ${name} <span class="badge bg-dark bg-opacity-50 text-white border border-secondary ms-2" style="font-size: 0.6rem">${zone.lactate}</span>
                        </h5>
                        <p class="mb-0 text-secondary small">${desc}</p>
                    </div>
                    <div class="text-end">
                        <small class="text-uppercase text-secondary fw-bold" style="font-size: 0.65rem;">Ritmo / 100m</small>
                        <h3 class="fw-bold mb-0 fw-mono ${textColor}" ${textStyle}>${formatMinSec(tFast)} - ${formatMinSec(tSlow)}</h3>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

// --- 3. Workout Builder ---
function initWorkoutBuilder() {
    const inputs = ['wbStyle', 'wbDist', 'wbZone'];
    inputs.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', calculateWorkout);
    });
}

function calculateWorkout() {
    // 1. Get Elements safely
    const elStyle = document.getElementById('wbStyle');
    const elDist = document.getElementById('wbDist');
    const elZone = document.getElementById('wbZone');
    const elTarget = document.getElementById('wbTargetTime');
    const elAdvice = document.getElementById('wbRestAdvice');
    const elAlert = document.getElementById('wbAlert');
    const elBar = document.getElementById('wbZoneColorBar');

    if (!elStyle || !elDist || !elZone) return;

    // 2. Get Values
    const style = elStyle.value;
    const dist = parseInt(elDist.value) || 0;
    const zoneKey = elZone.value;

    // 3. Fallback Pace if CSS is not set (User Request)
    // Default to a moderate pace (e.g., 1:40/100m = 100s) if no CSS is calculated
    let currentPace = 100;
    if (swimState && swimState.cssPace && swimState.cssPace > 0) {
        currentPace = swimState.cssPace;
    }

    // 4. Calculate Target
    const basePace100 = currentPace * (STYLE_FACTORS[style] || 1.0);
    const zoneData = ZONES[zoneKey];

    // Safely handle missing zone data
    if (!zoneData) return;

    // Avg factor for target
    const avgFactor = (zoneData.factorMin + zoneData.factorMax) / 2;
    const targetSeconds = (basePace100 * avgFactor) * (dist / 100);

    // 5. Update UI
    if (elTarget) elTarget.textContent = formatMinSec(targetSeconds);

    // Update Color Bar
    const colorMap = {
        rec: 'linear-gradient(to right, #0dcaf0, #3dd5f3)',
        en1: 'linear-gradient(to right, #198754, #20c997)',
        en2: 'linear-gradient(to right, #ffc107, #ffca2c)',
        en3: 'linear-gradient(to right, #fd7e14, #ff9800)',
        sp: 'linear-gradient(to right, #dc3545, #ff4d4d)'
    };
    if (elBar) elBar.style.background = colorMap[zoneKey] || '#ccc';

    // Rest Advice
    let advice = "";
    if (zoneKey === 'rec') advice = "15s - 30s. Recuperación incompleta o completa según objetivo.";
    else if (zoneKey === 'en1') advice = "10s - 20s. Descansos cortos para mantener pulso.";
    else if (zoneKey === 'en2') advice = "20s - 40s. Relación 1:4 o 1:3 trabajo/descanso.";
    else if (zoneKey === 'en3') advice = "1:1 o 1:1.5 Trabajo/Descanso. Recuperación casi completa.";
    else if (zoneKey === 'sp') advice = "1:2 a 1:5. Descanso MUY largo para vaciar lactato.";

    if (elAdvice) elAdvice.textContent = advice;

    // Alert for Sprint
    if (elAlert) {
        if (zoneKey === 'sp') elAlert.classList.remove('d-none');
        else elAlert.classList.add('d-none');
    }
}

// --- 4. SWOLF ---
function initSwolf() {
    const btn = document.getElementById('btnCalcSwolf');
    if (!btn) return;

    btn.addEventListener('click', () => {
        const timeStr = document.getElementById('swolfTime').value;
        const time = parseFloat(timeStr) || parseTime(timeStr); // Handle both updated seconds input and old format just in case
        const strokes = parseFloat(document.getElementById('swolfStrokes').value) || 0;
        const pool = parseInt(document.getElementById('swolfPool').value) || 25;

        if (time <= 0 || strokes <= 0) {
            alert("Introduce tiempo y brazadas válidos.");
            return;
        }

        const score = Math.round(time + strokes);
        const hz = strokes / time;
        const spm = hz * 60;
        const amp = pool / strokes;

        const elScore = document.getElementById('resSwolfScore');
        const elFreq = document.getElementById('resSwimFreq');
        const elHz = document.getElementById('resSwimHz');
        const elAmp = document.getElementById('resSwimAmp');

        if (elScore) elScore.textContent = score;
        if (elFreq) elFreq.textContent = spm.toFixed(0);
        if (elHz) elHz.textContent = hz.toFixed(2) + " Hz";
        if (elAmp) elAmp.textContent = amp.toFixed(2);

        // Feedback
        let feedback = "Eficiencia estándar.";
        if (score < 30) feedback = "¡Nivel Élite! Eficiencia hidrodinámica excepcional.";
        else if (score < 40) feedback = "Nivel Muy Bueno. Excelente deslizamiento.";
        else if (score < 50) feedback = "Nivel Medio. Buen equilibrio frecuencia/longitud.";
        else feedback = "Mejorable. Intenta reducir brazadas y aumentar el deslizamiento.";

        if (spm > 50 && amp < 1.0) feedback += " (Atención: Frecuencia muy alta con poca amplitud. Estás 'patinando'.)";

        document.getElementById('resSwolfFeedback').textContent = feedback;
        // document.getElementById('resSwolfText').textContent = "Tip técnico: " + feedback;

        document.getElementById('swolfResultPlaceholder').classList.add('d-none');
        document.getElementById('swolfResult').classList.remove('d-none');
    });
}

// --- 5. ACWR ---
function initAcwr() {
    const btn = document.getElementById('btnCalcAcwr');
    if (!btn) return;

    btn.addEventListener('click', () => {
        const acute = parseFloat(document.getElementById('acwrAcute').value) || 0;
        const chronic = parseFloat(document.getElementById('acwrChronic').value) || 0;

        if (chronic === 0) {
            alert("La Carga Crónica no puede ser 0.");
            return;
        }

        const ratio = acute / chronic;
        document.getElementById('resAcwrRatio').textContent = ratio.toFixed(2);

        const statusEl = document.getElementById('resAcwrStatus');
        const zoneBadge = document.getElementById('resAcwrZone');
        const resultDiv = document.getElementById('acwrResult');
        const resultPlaceholder = document.getElementById('acwrResultPlaceholder');

        // Reset Colors
        statusEl.className = "text-uppercase fw-bold mb-4";

        let statusText = "";
        let zoneText = "";
        let colorClass = ""; // For badge/ratio color

        if (ratio < 0.80) {
            statusText = "Riesgo de Desentrenamiento";
            zoneText = "Zona Baja";
            colorClass = "text-success";
            zoneBadge.className = "badge bg-success border";
        } else if (ratio <= 1.30) {
            statusText = "Zona Óptima (Sweet Spot)";
            zoneText = "Zona Segura";
            colorClass = "text-success";
            zoneBadge.className = "badge bg-success border";
        } else if (ratio <= 1.50) {
            statusText = "Sobrecarga Alta";
            zoneText = "Precaución";
            colorClass = "text-warning";
            zoneBadge.className = "badge bg-warning text-dark border";
        } else {
            statusText = "Peligro Crítico de Lesión";
            zoneText = "Zona Roja";
            colorClass = "text-danger";
            zoneBadge.className = "badge bg-danger border";
        }

        statusEl.textContent = statusText;
        statusEl.classList.add(colorClass);
        zoneBadge.textContent = zoneText;

        resultPlaceholder.classList.add('d-none');
        resultDiv.classList.remove('d-none');
    });
}

// --- AI Handlers (Preserved) ---
function handleAIAnalysisWrapper(results) {
    // Hide Overlay
    const overlay = document.getElementById('swimAiOverlay');
    if (overlay) {
        overlay.classList.add('fade-out');
        setTimeout(() => {
            overlay.classList.add('d-none');
            overlay.classList.remove('fade-out');
        }, 500);
    }

    // Show Results Dashboard
    const resultBox = document.getElementById('swimResultBox');
    resultBox.classList.remove('d-none');
    document.getElementById('swimResultEmpty').classList.add('d-none');

    // Restore Video Controls
    const video = document.getElementById('swimVideoPlayer');
    if (video) {
        video.controls = true;
        video.onclick = null;
    }

    const html = `
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="glass-card h-100 text-center position-relative overflow-hidden border-primary border-opacity-25 bg-primary bg-opacity-10">
                    <h6 class="text-primary text-uppercase small fw-bold mb-2">Total Strokes</h6>
                    <h2 class="display-4 fw-bold mb-0 text-white">${results.strokeCount}</h2>
                    <small class="text-secondary">Cycles detected</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="glass-card h-100 text-center position-relative overflow-hidden border-info border-opacity-25 bg-info bg-opacity-10">
                    <h6 class="text-info text-uppercase small fw-bold mb-2">Frequency</h6>
                    <h2 class="display-4 fw-bold mb-0 text-white">${results.avgSPM.toFixed(1)}</h2>
                    <small class="text-secondary">${results.avgHz} Hz</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="glass-card h-100 text-center position-relative overflow-hidden border-success border-opacity-25 bg-success bg-opacity-10">
                    <h6 class="text-success text-uppercase small fw-bold mb-2">Efficiency</h6>
                    <h2 class="display-4 fw-bold mb-0 text-white">88<span class="fs-5">%</span></h2>
                    <small class="text-secondary">AI Score</small>
                </div>
            </div>
        </div>
    `;

    const mockOutput = document.getElementById('aiOutputMock');
    if (mockOutput) {
        mockOutput.innerHTML = html;
        mockOutput.classList.remove('d-none');
    }
}

function handleAIAnalysis() {
    const results = videoProcessor.getAnalysisResults();
    if (results && results.detected) {
        handleAIAnalysisWrapper(results);
    }
}

// --- Helpers ---
function parseTime(timeStr) {
    if (!timeStr) return 0;
    const str = timeStr.toString().replace(',', '.').trim();
    if (str.includes(':')) {
        const parts = str.split(':');
        const min = parseFloat(parts[0]) || 0;
        const sec = parseFloat(parts[1]) || 0;
        return (min * 60) + sec;
    } else {
        return parseFloat(str) || 0;
    }
}

function formatMinSec(totalSeconds) {
    if (!totalSeconds || totalSeconds === Infinity || isNaN(totalSeconds)) return "--:--";
    const m = Math.floor(totalSeconds / 60);
    const s = Math.floor(totalSeconds % 60);
    return `${m}:${s < 10 ? '0' : ''}${s}`;
}

function capitalize(s) {
    return s.charAt(0).toUpperCase() + s.slice(1);
}
